.snowplow_load: &snowplow_load
  image: registry.gitlab.com/gitlab-data/data-image/data-image:latest
  stage: extract
  before_script:
    - cd transform/util/
    - export PATH="$CI_PROJECT_DIR/orchestration/:$PATH"
  tags:
    - analytics

.snowflake_dbt_jobs: &snowflake_dbt_jobs
  image: registry.gitlab.com/gitlab-data/data-image/data-image:latest
  stage: model
  before_script:
    - cd transform/snowflake-dbt/
    - echo $SNOWFLAKE_DATABASE
    - if [ $SNOWFLAKE_DATABASE = "master" ]; then export SNOWFLAKE_TRANSFORM_DATABASE="ANALYTICS"; else export SNOWFLAKE_TRANSFORM_DATABASE="${CI_COMMIT_REF_NAME^^}_ANALYTICS"; fi
    - echo $SNOWFLAKE_TRANSFORM_DATABASE
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_MR_XS_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
  tags:
    - analytics

# Load
snowplow_load:
  <<: *snowplow_load
  script:
    - python3 execute_copy.py
  only:
    refs:
      - master
    variables:
      - $SNOWPLOW_LOAD

snowplow_load_manual:
  <<: *snowplow_load
  script:
    - python3 execute_copy.py
  only:
    refs:
      - branches
  when: manual

# Model
.dbt_snowflake: &dbt_snowflake
  <<: *snowflake_dbt_jobs
  script:
    - dbt deps --profiles-dir profile # install packages
    - dbt seed --profiles-dir profile --target prod #seed data from csv
    - dbt run --profiles-dir profile --target prod --exclude snapshots # run without snapshot models
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_DBT

.dbt_snowflake_full_refresh: &dbt_snowflake
  <<: *snowflake_dbt_jobs
  script:
    - export CURRENT_DBT_WAREHOUSE=$SNOWFLAKE_MR_XL_WAREHOUSE
    - dbt deps --profiles-dir profile # install packages
    - dbt seed --profiles-dir profile --target prod #seed data from csv
    - dbt run --profiles-dir profile --target prod --full-refresh
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_DBT_FULL

.dbt_snowflake_archive_script: &dbt_snowflake_archive_script
  <<: *snowflake_dbt_jobs
  script:
    - dbt deps --profiles-dir profile # install packages
    - dbt archive --profiles-dir profile --target prod # archive tables that snapshot models need
    - dbt run --profiles-dir profile --target prod --models snapshots # update models that rely on archives

.dbt_snowflake_archive: &dbt_snowflake_archive
  <<: *dbt_snowflake_archive_script
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_DBT_ARCHIVE

mr_dbt_archive_manual: &mr_dbt_archive_manual
  <<: *dbt_snowflake_archive_script
  only:
    - branches
  when: manual

.dbt_snowflake_full_refresh: &dbt_snowflake_full_refresh
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_MR_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh
  when: manual

mr_dbt_all: &mr_dbt_all
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_MR_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh
    - dbt test --profiles-dir profile --target ci
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci
    - dbt test --profiles-dir profile --target ci
  only:
    - branches
  when: manual

mr_dbt_exclude_product: &mr_dbt_exclude_product
  <<: *snowflake_dbt_jobs
  script:
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh --exclude tag:product
    - dbt test --profiles-dir profile --target ci --exclude tag:product
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --exclude tag:product
    - dbt test --profiles-dir profile --target ci --exclude tag:product
  only:
    - branches
  when: manual

mr_dbt_snowplow: &mr_dbt_snowplow
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_TRANSFORM_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh --models snowplow
    - dbt test --profiles-dir profile --target ci --models snowplow
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --models snowplow
    - dbt test --profiles-dir profile --target ci --models snowplow
  only:
    - branches
  when: manual

prod_dbt_snowplow_full_refresh:
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_TRANSFORM_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target prod #seed data from csv
    - dbt run --profiles-dir profile --target prod --full-refresh --models snowplow
    - dbt test --profiles-dir profile --target prod --models snowplow
  only:
    - master
  when: manual

mr_dbt_gitlab_dotcom: &mr_dbt_gitlab_dotcom
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_MR_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh --models gitlab_dotcom
    - dbt test --profiles-dir profile --target ci --models gitlab_dotcom
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --models gitlab_dotcom
    - dbt test --profiles-dir profile --target ci --models gitlab_dotcom
  only:
    - branches
  when: manual


mr_dbt_pings: &mr_dbt_pings
  <<: *snowflake_dbt_jobs
  script:
    - export SNOWFLAKE_TRANSFORM_WAREHOUSE=$SNOWFLAKE_MR_XL_WAREHOUSE
    - echo $SNOWFLAKE_TRANSFORM_WAREHOUSE
    - python3 macro_name_check.py
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --full-refresh --models pings
    - dbt test --profiles-dir profile --target ci --models pings
    - dbt seed --profiles-dir profile --target ci #seed data from csv
    - dbt run --profiles-dir profile --target ci --models pings
    - dbt test --profiles-dir profile --target ci --models pings
  only:
    - branches
  when: manual

# Model tests
mr_dbt_tests_manual:
  <<: *snowflake_dbt_jobs
  stage: model_tests
  script:
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target prod #seed data from csv
    - dbt test --profiles-dir profile --target prod
  only:
    - branches
  when: manual

.dbt_snowflake_tests:
  <<: *snowflake_dbt_jobs
  stage: model_tests
  script:
    - dbt deps --profiles-dir profile
    - dbt seed --profiles-dir profile --target prod #seed data from csv
    - dbt test --profiles-dir profile --target prod
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_DBT_TESTS