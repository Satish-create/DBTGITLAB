.snowflake_load: &snowflake_load
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest
  stage: extract
  before_script:
    - cd transform/util/
    - pip3 install -U snowflake-sqlalchemy
  tags:
    - analytics

.snowflake_dbt_jobs: &snowflake_dbt_jobs
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest
  stage: model
  variables:
    SF_DATABASE: $CI_COMMIT_REF_NAME
  before_script:
    - cd transform/snowflake-dbt/
    - export SF_DATABASE="${SF_DATABASE^^}"
    - echo $SF_DATABASE
  tags:
    - analytics

# Load
snowflake_load:
  <<: *snowflake_load
  script:
    - python3 execute_copy.py
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_LOAD

snowflake_load_manual:
  <<: *snowflake_load
  script:
    - python3 execute_copy.py
  only:
    refs:
      - master
  when: manual

# Model
dbt_snowflake:
  <<: *snowflake_dbt_jobs
  script:
    - dbt -d deps --profiles-dir profile
    - dbt -d run --profiles-dir profile --target prod
    - dbt -d test --profiles-dir profile --target prod
  only:
    refs:
      - master
    variables:
      - $SNOWFLAKE_DBT

dbt_snowflake_run:
  <<: *snowflake_dbt_jobs
  script:
    - dbt -d deps --profiles-dir profile
    - dbt -d run --profiles-dir profile --target prod
    - dbt -d test --profiles-dir profile --target prod
  only:
    refs:
      - branches
  when: manual

dbt_snowflake_full_refresh:
  <<: *snowflake_dbt_jobs
  script:
    - dbt -d deps --profiles-dir profile
    - dbt -d run --profiles-dir profile --target prod --full-refresh
    - dbt -d test --profiles-dir profile --target prod
  when: manual

dbt_snowflake_full_refresh:
  <<: *snowflake_dbt_jobs
  script:
    - dbt -d deps --profiles-dir profile
    - dbt -d run --profiles-dir profile --target prod --full-refresh
    - dbt -d test --profiles-dir profile --target prod
  when: manual

snowflake_mr_dbt:
  <<: *snowflake_dbt_jobs
  script:
    - dbt -d deps --profiles-dir profile
    - dbt -d run --profiles-dir profile --target prod --full-refresh
    - dbt -d run --profiles-dir profile --target prod
    - dbt -d test --profiles-dir profile --target prod
  when: manual