# Job definitions
#
.job_template: &extract_definition
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest
  tags:
    - analytics

.variables: &meltano_extract_job__variables
  SINGER_RUN_DIR: /run/singer
  TARGET_REJECTED_DIR: $SINGER_RUN_DIR/target.rejected
  MELTANO_JOB_ID: $CI_JOB_NAME
  SNOWFLAKE_USER: $SNOWFLAKE_LOAD_USER
  SNOWFLAKE_PASSWORD: $SNOWFLAKE_LOAD_PASSWORD
  SNOWFLAKE_ROLE: $SNOWFLAKE_LOAD_ROLE
  SNOWFLAKE_WAREHOUSE: $SNOWFLAKE_LOAD_WAREHOUSE
  SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME  # review database

.meltano_extract_job: &meltano_extract_job
  stage: extract
  <<: *extract_definition
  variables: *meltano_extract_job__variables
  image:
    name: registry.gitlab.com/meltano/meltano/runner:bc2ead1146c017a4ad12c88d65f19dd968a23d8b
    entrypoint: [""]
  script:
    - pip3 install -r orchestration/requirements.txt # required by `ci_helpers`
    - export SNOWFLAKE_DATABASE="${SNOWFLAKE_DATABASE^^}" # database name must be in CAPS
    - echo "Connecting to $SNOWFLAKE_USER[$SNOWFLAKE_ROLE]@$SNOWFLAKE_ACCOUNT/$SNOWFLAKE_DATABASE/$SNOWFLAKE_SCHEMA"
    - meltano install
    - ci_helpers.py use_proxy "meltano elt $MELTANO_JOB_ID --extractor $MELTANO_EXTRACTOR --loader $MELTANO_LOADER --transform skip"

.ci_stats: &ci_stats
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_ci_stats.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest ci_stats"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest ci_stats --hours 8"

.netsuite_extract: &netsuite_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/netsuite/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite apply_schema"
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite export --days 3"
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite backlog --days 15"

.netsuite_backlog: &netsuite_backlog
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/netsuite/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite backlog --days 60"

.netsuite_currency_rate_backfill: &netsuite_currency_rate_backfill
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/netsuite/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite backlog --backfill-entity currency_rate --days 1460"

.pings_extract: &pings_extract
  stage: extract
  <<: *extract_definition
  variables:
    PINGS_LOAD_DAYS: 2
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - echo "Days to load = $PINGS_LOAD_DAYS"
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest version --days $PINGS_LOAD_DAYS"
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest customers"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest customers --days $PINGS_LOAD_DAYS"
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest license"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest license --days $PINGS_LOAD_DAYS"

.pings_backfill: &pings_backfill
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest version"

.gitlab_profiler_extract: &gitlab_profiler_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest gitlab_profiler"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest gitlab_profiler --days 15"

.gitlab_profiler_backfill: &gitlab_profiler_backfill
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest gitlab_profiler"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest gitlab_profiler --days 3600"

.postgres_db_extract: &postgres_db_extract
  stage: extract
  <<: *extract_definition
  image:
    name: registry.gitlab.com/meltano/meltano/runner:v0.1.4
    entrypoint: [""]
  script:
    - pip3 install -r orchestration/requirements.txt # required by `ci_helpers`
    - export SNOWFLAKE_DATABASE="${SNOWFLAKE_DATABASE^^}" # database name must be in CAPS
    - check_ci_cd_vars.py --file extract/postgres/config/required_vars.yaml
    - meltano install
    - python3 extract/postgres --import_db $EXPORT_DATABASE --days $DAYS --hours $HOURS
    - extract/postgres/run_custom_tap_target.sh

.sheetload_snowflake: &sheetload_snowflake
  stage: extract
  <<: *extract_definition
  script:
    - pip3 install -U pyasn1-modules
    - pip3 install -U snowflake-sqlalchemy
    - cd extract/sheetload/
    - python3 sheetload.py sheets sheets.txt snowflake

.sfdc_extract: &sfdc_extract
  variables:
    FIXED_SFDC_PASSWORD: $SFDC_PASSWORD_NOTOKEN
  stage: extract
  <<: *extract_definition
  script:
    - pip3 install salesforce-bulk # TODO: add me to the container
    - ci_helpers.py use_proxy "python3 extract/sfdc/src/ --schema sfdc apply_schema"
    - ci_helpers.py use_proxy "python3 extract/sfdc/src/ --schema sfdc export"

.domains_extract: &domains_extract
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "bash transform/hosts_to_sfdc/python_timecheck.sh"

.gitlab_extract: &gitlab_extract
  stage: extract
  retry: 1
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "python3 extract/gitlab/src -S gitlab apply_schema"
    - ci_helpers.py use_proxy "python3 extract/gitlab/src -S gitlab export"

.discover_gitlab_dbs_schema: &discover_gitlab_dbs_schema
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_ci_stats.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest ci_stats"
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest customers"
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest license"
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest gitlab_profiler"

## Production Jobs

ci_stats:
  <<: *ci_stats
  only:
    refs:
      - master
    variables:
      - $CI_STATS

domains:
  <<: *domains_extract
  only:
    refs:
      - master
    variables:
      - $DOMAINS

gitlab:
  <<: *gitlab_extract
  only:
    refs:
      - master
    variables:
      - $GITLAB

gitlab_profiler:
  <<: *gitlab_profiler_extract
  only:
    refs:
      - master
    variables:
      - $GITLAB_PROFILER

netsuite:
  <<: *netsuite_extract
  only:
    refs:
      - master
    variables:
      - $NETSUITE

pings:
  stage: extract
  <<: *pings_extract
  only:
    refs:
      - master
    variables:
      - $PINGS

version_db:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $SNOWFLAKE_LOAD_DATABASE
    EXPORT_DATABASE: "version"
    DAYS: 1
    HOURS: 0
    AVG_CYCLE_ANALYTICS_ID: 1
  only:
    refs:
      - master
    variables:
      - $VERSION_DB_EXTRACTION

customers_db:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $SNOWFLAKE_LOAD_DATABASE
    EXPORT_DATABASE: "customers"
    DAYS: 1
    HOURS: 0
  only:
    refs:
      - master
    variables:
      - $CUSTOMERS_DB_EXTRACTION

license_db:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $SNOWFLAKE_LOAD_DATABASE
    EXPORT_DATABASE: "license"
    DAYS: 1
    HOURS: 0
  only:
    refs:
      - master
    variables:
      - $LICENSE_DB_EXTRACTION

ci_stats_db:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $SNOWFLAKE_LOAD_DATABASE
    EXPORT_DATABASE: "ci_stats"
    DAYS: 0
    HOURS: 8
  only:
    refs:
      - master
    variables:
      - $CI_STATS_DB_EXTRACTION

gitlab_profiler_db:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $SNOWFLAKE_LOAD_DATABASE
    EXPORT_DATABASE: "gitlab_profiler"
    DAYS: 15
    HOURS: 0
  only:
    refs:
      - master
    variables:
      - $GITLAB_PROFILER_DB_EXTRACTION

sfdc:
  <<: *sfdc_extract
  only:
    refs:
      - master
    variables:
      - $SFDC

sheetload_snowflake:
  stage: extract
  <<: *sheetload_snowflake
  only:
    refs:
      - master
    variables:
      - $SHEETLOAD_SNOWFLAKE

## Review Jobs

ci_stats_manual:
  <<: *ci_stats
  only:
    - branches
  except:
    - master
  when: manual

domains_manual:
  <<: *domains_extract
  only:
    - branches
  except:
    - master
  when: manual

gitlab_manual:
  <<: *gitlab_extract
  only:
    - branches
  except:
    - master
  when: manual

netsuite_backlog_manual:
  stage: extract
  <<: *netsuite_backlog
  when: manual

netsuite_currency_rate_backfill_manual:
  stage: extract
  <<: *netsuite_currency_rate_backfill
  when: manual

netsuite_manual:
  <<: *netsuite_extract
  only:
    - branches
  except:
    - master
  when: manual

pings_manual:
  stage: extract
  <<: *pings_extract
  only:
    - branches
  except:
    - master
  when: manual

pings_backfill:
  stage: extract
  <<: *pings_backfill
  only:
    - master
  when: manual

gitlab_profiler_manual:
  stage: extract
  <<: *gitlab_profiler_backfill
  only:
    - branches
  except:
    - master
  when: manual

gitlab_profiler_backfill:
  stage: extract
  <<: *gitlab_profiler_backfill
  only:
    - master
  when: manual

discover_gitlab_dbs_schema_manual:
  stage: extract
  <<: *discover_gitlab_dbs_schema
  only:
    - branches
  except:
    - master
  when: manual

version_db_manual:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME
    EXPORT_DATABASE: "version"
    DAYS: 1
    HOURS: 0
    AVG_CYCLE_ANALYTICS_ID: 1341780
  only:
    - branches
  except:
    - master
  when: manual

customers_db_manual:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME
    EXPORT_DATABASE: "customers"
    DAYS: 1
    HOURS: 0
  only:
    - branches
  except:
    - master
  when: manual

license_db_manual:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME
    EXPORT_DATABASE: "license"
    DAYS: 1
    HOURS: 0
  only:
    - branches
  except:
    - master
  when: manual

ci_stats_db_manual:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME
    EXPORT_DATABASE: "ci_stats"
    DAYS: 0
    HOURS: 8
  only:
    - branches
  except:
    - master
  when: manual

gitlab_profiler_db_manual:
  stage: extract
  <<: *postgres_db_extract
  variables:
    SNOWFLAKE_DATABASE: $CI_COMMIT_REF_NAME
    EXPORT_DATABASE: "gitlab_profiler"
    DAYS: 15
    HOURS: 0
  only:
    - branches
  except:
    - master
  when: manual

sfdc_manual:
  <<: *sfdc_extract
  only:
    - branches
  except:
    - master
  when: manual

sheetload_snowflake_manual:
  stage: extract
  <<: *sheetload_snowflake
  when: manual

# Stage: test

.test_job_template: &test_job_template
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest

